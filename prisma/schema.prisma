generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  eleve
  enseignant
  parent
  admin
}

enum CopieStatus {
  pending
  processing
  done
  error
}

enum SubscriptionPlan {
  FREE
  MONTHLY
  LIFETIME
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  PAUSED
}

enum PaymentProvider {
  CLICTOPAY
}

enum PaymentStatus {
  PENDING
  ACCEPTED
  REFUSED
  ERROR
}

model User {
  id           String          @id @default(uuid())
  email        String          @unique
  passwordHash String
  passwordSalt String
  role         UserRole        @default(eleve)
  profile      StudentProfile?
  sessions     Session[]
  memoryEvents MemoryEvent[]
  evaluations  Evaluation[]
  epreuves     EpreuveBlanche[]
  copies       CopieDeposee[]
  oralSessions OralSession[]
  subscription Subscription?
  payments     PaymentTransaction[]
  usages       UsageCounter[]
  pushSubscriptions PushSubscription[]
  complianceLogs    ComplianceLog[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

model Session {
  token      String   @id
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  lastSeenAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model MemoryEvent {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  feature   String
  path      String?
  payload   Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([type])
}

model StudentProfile {
  id                  String    @id @default(uuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName         String
  classLevel          String
  targetScore         String
  establishment       String?
  eafDate             DateTime?
  onboardingCompleted Boolean   @default(false)
  selectedOeuvres     String[]  @default([])
  classCode           String?
  parcoursProgress    String[]  @default([])
  badges              String[]  @default([])
  xp                  Int       @default(0)
  level               Int       @default(1)
  xpToNextLevel       Int       @default(100)
  preferredObjects    String[]  @default([])
  weakSkills          String[]  @default([])
  skillMap            Json?
  streak              Int       @default(0)
  maxStreak           Int       @default(0)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

model Evaluation {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  kind        String
  score       Float
  maxScore    Float
  status      String
  payload     Json?
  evaluatedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([userId, evaluatedAt])
}

model EpreuveBlanche {
  id          String         @id @default(uuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String
  sujet       String
  texte       String
  consignes   String
  bareme      Json
  generatedAt DateTime       @default(now())
  createdAt   DateTime       @default(now())
  copies      CopieDeposee[]

  @@index([userId, generatedAt])
}

model CopieDeposee {
  id          String         @id @default(uuid())
  epreuveId   String
  userId      String
  epreuve     EpreuveBlanche @relation(fields: [epreuveId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  filePath    String
  fileType    String
  status      CopieStatus    @default(pending)
  ocrText     String?
  correction  Json?
  createdAt   DateTime       @default(now())
  correctedAt DateTime?

  @@index([userId, createdAt])
  @@index([epreuveId])
}

enum OralSessionStatus {
  DRAFT
  PREP_RUNNING
  PREP_ENDED
  PASSAGE_RUNNING
  PASSAGE_DONE
  FINALIZED
  ABANDONED
}

enum OralMode {
  SIMULATION
  FREE_PRACTICE
}

enum OralPhase {
  LECTURE
  EXPLICATION
  GRAMMAIRE
  ENTRETIEN
}

model OralSession {
  id               String            @id @default(uuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  status           OralSessionStatus @default(DRAFT)
  mode             OralMode          @default(SIMULATION)
  anneeScolaire    String            @default("2025-2026")
  oeuvre           String
  extrait          String
  question         String
  draw             Json?             // { textId, excerptStart, excerptEnd, grammarQuestion, workId, parcoursId }
  transcript       String?
  score            Float?
  maxScore         Float?
  totalScore       Int?              // /20, null before finalization
  feedback         Json?
  pdfUrl           String?
  prepStartedAt    DateTime?
  prepEndedAt      DateTime?
  passageStartedAt DateTime?
  passageEndedAt   DateTime?
  phaseTimestamps  Json?             // { reading: {start,end}, explication: {start,end}, ... }
  endedAt          DateTime?
  createdAt        DateTime          @default(now())
  phaseScores      OralPhaseScore[]
  oralTranscript   OralTranscript?
  oralBilan        OralBilan?

  @@index([userId, createdAt])
  @@index([status])
  @@index([anneeScolaire])
}

model OralPhaseScore {
  id            String       @id @default(uuid())
  sessionId     String
  session       OralSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  phase         OralPhase
  score         Float
  maxScore      Float
  aiScore       Float?       // Raw AI-suggested score before clamping
  transcript    String?      @db.Text
  feedback      String?      @db.Text
  pointsForts   String[]     @default([])
  axes          String[]     @default([])
  criteria      Json?        // { [criterionId]: { label, score, maxScore, comment } }
  citations     Json?
  duration      Int          @default(0)
  createdAt     DateTime     @default(now())

  @@unique([sessionId, phase])
  @@index([sessionId])
}

model OralTranscript {
  id          String      @id @default(uuid())
  sessionId   String      @unique
  session     OralSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  fullText    String      @db.Text
  byPhase     Json?       // { LECTURE: "...", EXPLICATION: "...", ... }
  audioUrl    String?
  createdAt   DateTime    @default(now())
}

model OralBilan {
  id             String      @id @default(uuid())
  sessionId      String      @unique
  session        OralSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  note           Float       // /20
  mention        String
  bilanGlobal    String      @db.Text
  conseilFinal   String      @db.Text
  axesProgres    String[]    @default([])
  planRevision   Json?       // Spaced rep plan generated from this session
  citations      Json?
  createdAt      DateTime    @default(now())
}

model OfficialWork {
  id             String   @id @default(uuid())
  anneeScolaire  String   // e.g. '2025-2026'
  oeuvre         String
  auteur         String
  editeur        String?
  parcours       String
  objetEtude     String   // Roman, Poésie, Théâtre, etc.
  voie           String   @default("generale") // generale | technologique
  urlEduscol     String?
  urlBO          String?
  createdAt      DateTime @default(now())

  @@unique([anneeScolaire, oeuvre])
  @@index([anneeScolaire])
  @@index([objetEtude])
}

model Chunk {
  id             String                     @id @default(uuid())
  docId          String
  sourceTitle    String
  sourceUrl      String
  sourceType     String
  content        String
  embedding      Unsupported("vector(768)")?
  chunkIndex     Int
  title          String?
  authorityLevel String                     @default("D")
  docType        String?
  legalBasis     String?
  publishedAt    DateTime?
  sectionPath    String?
  page           Int?
  hash           String?                    @unique
  createdAt      DateTime                   @default(now())

  @@index([docId])
  @@index([sourceType])
  @@index([authorityLevel])
  @@index([docType])
}

model LlmCostLog {
  id           String   @id @default(cuid())
  userId       String?
  skill        String
  provider     String
  model        String
  tier         String
  inputTokens  Int      @default(0)
  outputTokens Int      @default(0)
  costEurCents Int      @default(0)
  latencyMs    Int      @default(0)
  success      Boolean  @default(true)
  errorCode    String?
  contextSize  Int?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([provider, createdAt])
  @@index([skill, createdAt])
  @@index([tier, createdAt])
}

model LlmBudgetAlert {
  id            String   @id @default(cuid())
  period        String
  totalEurCents Int
  threshold     Int
  alertedAt     DateTime @default(now())
}

model Subscription {
  id                 String             @id @default(uuid())
  userId             String             @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  externalCustomerId String?
  externalContractId String?
  plan               SubscriptionPlan   @default(FREE)
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)
  trialEnd           DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([plan, status])
}

model UsageCounter {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feature    String
  periodKey  String
  count      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, feature, periodKey])
  @@index([periodKey, feature])
}

model PaymentTransaction {
  id               String          @id @default(uuid())
  userId           String
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider         PaymentProvider @default(CLICTOPAY)
  status           PaymentStatus   @default(PENDING)
  plan             SubscriptionPlan
  amountMillimes   Int
  currency         String          @default("TND")
  orderRef         String          @unique
  providerRef      String?
  callbackPayload  Json?
  initiatedAt      DateTime        @default(now())
  completedAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([userId, createdAt])
  @@index([provider, status])
}

model ErrorBankItem {
  id                String   @id @default(uuid())
  studentId         String
  errorType         String
  errorContext      String   @db.Text
  correction        String   @default("") @db.Text
  severity          String   @default("major")
  sourceInteractionId String?
  nextRevision      DateTime?
  revisionCount     Int      @default(0)
  archivedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([studentId, nextRevision])
  @@index([studentId, archivedAt])
}

model ComplianceLog {
  id        String   @id @default(cuid())
  ruleId    String
  action    String
  reason    String
  skill     String
  studentId String?
  user      User?    @relation(fields: [studentId], references: [id], onDelete: SetNull)
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([ruleId, createdAt])
  @@index([studentId, createdAt])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}
