generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  eleve
  enseignant
  parent
  admin
}

enum CopieStatus {
  pending
  processing
  done
  error
}

enum SubscriptionPlan {
  FREE
  PRO
  MAX
  MONTHLY
  LIFETIME
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  PAUSED
}

enum PaymentProvider {
  CLICTOPAY
}

enum PaymentStatus {
  PENDING
  ACCEPTED
  REFUSED
  ERROR
}

model User {
  id           String          @id @default(uuid())
  email        String          @unique
  passwordHash String
  passwordSalt String
  role         UserRole        @default(eleve)
  profile      StudentProfile?
  sessions     Session[]
  memoryEvents MemoryEvent[]
  evaluations  Evaluation[]
  epreuves     EpreuveBlanche[]
  copies       CopieDeposee[]
  oralSessions OralSession[]
  subscription Subscription?
  payments     PaymentTransaction[]
  usages       UsageCounter[]
  pushSubscriptions PushSubscription[]
  complianceLogs    ComplianceLog[]
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
}

model Session {
  token      String   @id
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  lastSeenAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model MemoryEvent {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  feature   String
  path      String?
  payload   Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([type])
}

model StudentProfile {
  id                  String      @id @default(uuid())
  userId              String      @unique
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  displayName         String
  classLevel          String
  targetScore         String
  establishment       String?
  eafDate             DateTime?
  onboardingCompleted Boolean     @default(false)
  selectedOeuvres     String[]    @default([])
  classCode           String?
  parcoursProgress    String[]    @default([])
  badges              String[]    @default([])
  xp                  Int         @default(0)
  level               Int         @default(1)
  xpToNextLevel       Int         @default(100)
  preferredObjects    String[]    @default([])
  weakSkills          String[]    @default([])
  skillMap            Json?
  streak              Int         @default(0)
  maxStreak           Int         @default(0)
  // ADDENDUM fields
  voie                Voie        @default(GENERALE)
  anneeScolaire       String      @default("2025-2026")
  targetExamDate      DateTime?
  weeklyGoalMinutes   Int         @default(120)
  prefWorkingHours    Json?
  accessibilityNeeds  Json?
  personaPreference   ExamPersona @default(NEUTRE)
  globalLevel         SkillLevel  @default(INSUFFISANT)
  globalLevelUpdatedAt DateTime?
  // Relations ADDENDUM
  skillMapEntries     SkillMapEntry[]
  weakSkillEntries    WeakSkillEntry[]
  workMasteries       WorkMastery[]
  memorySummaries     MemorySummary[]
  documentDeposits    DocumentDeposit[]
  agentInteractions   AgentInteraction[]
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}

model Evaluation {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  kind        String
  score       Float
  maxScore    Float
  status      String
  payload     Json?
  evaluatedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([userId, evaluatedAt])
}

model EpreuveBlanche {
  id          String         @id @default(uuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String
  sujet       String
  texte       String
  consignes   String
  bareme      Json
  generatedAt DateTime       @default(now())
  createdAt   DateTime       @default(now())
  copies      CopieDeposee[]

  @@index([userId, generatedAt])
}

model CopieDeposee {
  id          String         @id @default(uuid())
  epreuveId   String
  userId      String
  epreuve     EpreuveBlanche @relation(fields: [epreuveId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  filePath    String
  fileType    String
  status      CopieStatus    @default(pending)
  ocrText     String?
  correction  Json?
  createdAt   DateTime       @default(now())
  correctedAt DateTime?

  @@index([userId, createdAt])
  @@index([epreuveId])
}

enum OralSessionStatus {
  DRAFT
  PREP_RUNNING
  PREP_ENDED
  PASSAGE_RUNNING
  PASSAGE_DONE
  FINALIZED
  ABANDONED
}

enum OralMode {
  SIMULATION
  FREE_PRACTICE
}

enum Voie {
  GENERALE
  TECHNOLOGIQUE
}

enum SkillLevel {
  INSUFFISANT
  PASSABLE
  SATISFAISANT
  EXCELLENT
}

enum ExamPersona {
  BIENVEILLANT
  NEUTRE
  HOSTILE
  RANDOM
}

enum SkillTrend {
  IMPROVING
  STABLE
  DECLINING
}

enum EafSkill {
  ORAL_LECTURE_FLUIDITE
  ORAL_LECTURE_EXPRESSIVITE
  ORAL_EXPLIC_MOUVEMENT
  ORAL_EXPLIC_ANALYSE
  ORAL_EXPLIC_CITATIONS
  ORAL_EXPLIC_OUVERTURE
  ORAL_GRAMM_IDENTIFICATION
  ORAL_GRAMM_ANALYSE
  ORAL_ENTRETIEN_CONNAISSANCE
  ORAL_ENTRETIEN_REACTIVITE
  ORAL_ENTRETIEN_CULTURE
  ORAL_ENTRETIEN_CRITIQUE
  ECRIT_COMMENT_PLAN
  ECRIT_COMMENT_ANALYSE
  ECRIT_COMMENT_CITATIONS
  ECRIT_DISSERT_THESE
  ECRIT_DISSERT_TRANSITION
  ECRIT_DISSERT_EXEMPLES
  TRANS_LANGUE_GRAMMAIRE
  TRANS_LANGUE_STYLE
  TRANS_LANGUE_SYNTAXE
  TRANS_TEMPS_GESTION
  TRANS_CULTURE_GENERALE
}

enum WeakSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum WeakStatus {
  ACTIVE
  IMPROVING
  RESOLVED
  DISMISSED
}

enum SummaryType {
  FULL
  ORAL
  ECRIT
  RECENT_SESSIONS
  WEAK_SKILLS
}

enum DocStatus {
  DOC_PENDING
  DOC_PROCESSING
  DOC_DONE
  DOC_ERROR
}

enum DocType {
  COPIE_ECRIT
  ENREGISTREMENT_ORAL
  RESSOURCE
  AUTRE
}

enum AgentTypeEnum {
  TIRAGE_ORAL
  SHADOW_PREP
  COACH_LECTURE
  COACH_EXPLICATION
  GRAMMAIRE_CIBLEE
  ENTRETIEN_OEUVRE
  BILAN_ORAL
  DIAGNOSTIC_ECRIT
  PASTICHE
  QUIZ_ADAPTATIF
  EXAMINATEUR_VIRTUEL
}

enum OralPhase {
  LECTURE
  EXPLICATION
  GRAMMAIRE
  ENTRETIEN
}

model OralSession {
  id               String            @id @default(uuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  status           OralSessionStatus @default(DRAFT)
  mode             OralMode          @default(SIMULATION)
  personaType      ExamPersona       @default(NEUTRE)
  anneeScolaire    String            @default("2025-2026")
  oeuvre           String
  extrait          String
  question         String
  draw             Json?             // { textId, excerptStart, excerptEnd, grammarQuestion, workId, parcoursId }
  transcript       String?
  score            Float?
  maxScore         Float?
  totalScore       Int?              // /20, null before finalization
  feedback         Json?
  pdfUrl           String?
  prepStartedAt    DateTime?
  prepEndedAt      DateTime?
  passageStartedAt DateTime?
  passageEndedAt   DateTime?
  phaseTimestamps  Json?             // { reading: {start,end}, explication: {start,end}, ... }
  endedAt          DateTime?
  createdAt        DateTime          @default(now())
  phaseScores      OralPhaseScore[]
  oralTranscript   OralTranscript?
  oralBilan        OralBilan?

  @@index([userId, createdAt])
  @@index([status])
  @@index([anneeScolaire])
}

model OralPhaseScore {
  id            String       @id @default(uuid())
  sessionId     String
  session       OralSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  phase         OralPhase
  score         Float
  maxScore      Float
  aiScore       Float?       // Raw AI-suggested score before clamping
  transcript    String?      @db.Text
  feedback      String?      @db.Text
  pointsForts   String[]     @default([])
  axes          String[]     @default([])
  criteria      Json?        // { [criterionId]: { label, score, maxScore, comment } }
  citations     Json?
  duration      Int          @default(0)
  createdAt     DateTime     @default(now())

  @@unique([sessionId, phase])
  @@index([sessionId])
}

model OralTranscript {
  id          String      @id @default(uuid())
  sessionId   String      @unique
  session     OralSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  fullText    String      @db.Text
  byPhase     Json?       // { LECTURE: "...", EXPLICATION: "...", ... }
  audioUrl    String?
  createdAt   DateTime    @default(now())
}

model OralBilan {
  id             String      @id @default(uuid())
  sessionId      String      @unique
  session        OralSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  note           Float       // /20
  mention        String
  bilanGlobal    String      @db.Text
  conseilFinal   String      @db.Text
  axesProgres    String[]    @default([])
  planRevision   Json?       // Spaced rep plan generated from this session
  citations      Json?
  createdAt      DateTime    @default(now())
}

model OfficialWork {
  id             String   @id @default(uuid())
  anneeScolaire  String   // e.g. '2025-2026'
  oeuvre         String
  auteur         String
  editeur        String?
  parcours       String
  objetEtude     String   // Roman, Poésie, Théâtre, etc.
  voie           String   @default("generale") // generale | technologique
  urlEduscol     String?
  urlBO          String?
  createdAt      DateTime @default(now())

  @@unique([anneeScolaire, oeuvre])
  @@index([anneeScolaire])
  @@index([objetEtude])
}

model Chunk {
  id             String                     @id @default(uuid())
  docId          String
  sourceTitle    String
  sourceUrl      String
  sourceType     String
  content        String
  embedding      Unsupported("vector(768)")?
  chunkIndex     Int
  title          String?
  authorityLevel String                     @default("D")
  docType        String?
  legalBasis     String?
  publishedAt    DateTime?
  sectionPath    String?
  page           Int?
  hash           String?                    @unique
  createdAt      DateTime                   @default(now())

  @@index([docId])
  @@index([sourceType])
  @@index([authorityLevel])
  @@index([docType])
}

model LlmCostLog {
  id           String   @id @default(cuid())
  userId       String?
  skill        String
  provider     String
  model        String
  tier         String
  inputTokens  Int      @default(0)
  outputTokens Int      @default(0)
  costEurCents Int      @default(0)
  latencyMs    Int      @default(0)
  success      Boolean  @default(true)
  errorCode    String?
  contextSize  Int?
  createdAt    DateTime @default(now())

  @@index([userId, createdAt])
  @@index([provider, createdAt])
  @@index([skill, createdAt])
  @@index([tier, createdAt])
}

model LlmBudgetAlert {
  id            String   @id @default(cuid())
  period        String
  totalEurCents Int
  threshold     Int
  alertedAt     DateTime @default(now())
}

model Subscription {
  id                 String             @id @default(uuid())
  userId             String             @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  externalCustomerId String?
  externalContractId String?
  plan               SubscriptionPlan   @default(FREE)
  status             SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean            @default(false)
  trialEnd           DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([plan, status])
}

model UsageCounter {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  feature    String
  periodKey  String
  count      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, feature, periodKey])
  @@index([periodKey, feature])
}

model PaymentTransaction {
  id               String          @id @default(uuid())
  userId           String
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider         PaymentProvider @default(CLICTOPAY)
  status           PaymentStatus   @default(PENDING)
  plan             SubscriptionPlan
  amountMillimes   Int
  currency         String          @default("TND")
  orderRef         String          @unique
  providerRef      String?
  callbackPayload  Json?
  initiatedAt      DateTime        @default(now())
  completedAt      DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([userId, createdAt])
  @@index([provider, status])
}

model ErrorBankItem {
  id                String   @id @default(uuid())
  studentId         String
  errorType         String
  errorContext      String   @db.Text
  correction        String   @default("") @db.Text
  severity          String   @default("major")
  sourceInteractionId String?
  nextRevision      DateTime?
  revisionCount     Int      @default(0)
  archivedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([studentId, nextRevision])
  @@index([studentId, archivedAt])
}

model ComplianceLog {
  id        String   @id @default(cuid())
  ruleId    String
  action    String
  reason    String
  skill     String
  studentId String?
  user      User?    @relation(fields: [studentId], references: [id], onDelete: SetNull)
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([ruleId, createdAt])
  @@index([studentId, createdAt])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  @@index([userId])
}

// ============================================================
// ADDENDUM — Memory Store Models (P0-SaaS-5)
// ============================================================

model SkillMapEntry {
  id               String         @id @default(uuid())
  profileId        String
  profile          StudentProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill            EafSkill
  score            Float          @default(0.0)
  confidence       Float          @default(0.0)
  trend            SkillTrend     @default(STABLE)
  observationCount Int            @default(0)
  srNextReview     DateTime?
  srInterval       Int            @default(1)
  srEaseFactor     Float          @default(2.5)
  srRepetitions    Int            @default(0)
  lastObservedAt   DateTime?

  @@unique([profileId, skill])
}

model WeakSkillEntry {
  id              String         @id @default(uuid())
  profileId       String
  profile         StudentProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill           EafSkill
  pattern         String
  category        String
  examples        Json           @default("[]")
  embedding       Unsupported("vector(1536)")?
  frequency       Int            @default(1)
  severity        WeakSeverity   @default(LOW)
  decayedScore    Float          @default(1.0)
  status          WeakStatus     @default(ACTIVE)
  firstDetectedAt DateTime       @default(now())
  lastOccurrence  DateTime       @default(now())
  resolvedAt      DateTime?

  @@index([profileId, status])
  @@index([severity])
}

model WorkMastery {
  id             String         @id @default(uuid())
  profileId      String
  profile        StudentProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  workId         String
  masteryLevel   Float          @default(0.0)
  srNextReview   DateTime       @default(now())
  srInterval     Int            @default(1)
  srEaseFactor   Float          @default(2.5)
  srRepetitions  Int            @default(0)
  strongThemes   Json           @default("[]")
  weakThemes     Json           @default("[]")
  citationsKnown Json           @default("[]")
  sessionsCount  Int            @default(0)
  lastSessionAt  DateTime?

  @@unique([profileId, workId])
}

model MemorySummary {
  id          String         @id @default(uuid())
  profileId   String
  profile     StudentProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  summaryType SummaryType
  content     String         @db.Text
  tokenCount  Int
  embedding   Unsupported("vector(1536)")?
  generatedAt DateTime       @default(now())
  validUntil  DateTime
  version     Int            @default(1)

  @@unique([profileId, summaryType])
}

model DocumentDeposit {
  id              String         @id @default(uuid())
  profileId       String
  profile         StudentProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  filename        String
  fileType        String
  fileSize        Int
  storageUrl      String
  storageKey      String
  ocrText         String?        @db.Text
  analysisResult  Json?
  analysisStatus  DocStatus      @default(DOC_PENDING)
  linkedSessionId String?
  workId          String?
  depositType     DocType
  createdAt       DateTime       @default(now())
  expiresAt       DateTime?
}

model AgentInteraction {
  id              String         @id @default(uuid())
  profileId       String
  profile         StudentProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  sessionId       String?
  agentType       AgentTypeEnum
  inputSummary    String
  outputSummary   String
  feedbackScore   Int?
  feedbackLabel   String?
  tokensUsed      Int
  latencyMs       Int
  ragSourcesCount Int            @default(0)
  createdAt       DateTime       @default(now())

  @@index([profileId, createdAt])
  @@index([agentType])
}
